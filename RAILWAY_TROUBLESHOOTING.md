# Railway Troubleshooting Guide

## Проблема: Healthcheck не проходит

### Что было исправлено:

1. **Улучшена обработка ошибок при старте:**
   - Приложение не падает, если БД недоступна
   - Приложение не падает, если JWT ключ не настроен
   - Миграции применяются асинхронно, не блокируя старт

2. **Добавлено логирование:**
   - Логируются переменные окружения при старте
   - Логируется информация о порте и доступных endpoint'ах

3. **Создан HealthController:**
   - Простой endpoint `/api/health` для проверки работоспособности
   - Не требует авторизацию

### Что проверить на Railway:

1. **Переменные окружения:**
   - `DATABASE_URL` - должен быть автоматически установлен Railway при подключении PostgreSQL
   - `REDIS_URL` - должен быть автоматически установлен Railway при подключении Redis
   - `Telegram__BotToken` - должен быть установлен вручную
   - `Jwt__Key` - должен быть установлен вручную
   - `Jwt__Issuer` - должен быть установлен вручную
   - `Jwt__Audience` - должен быть установлен вручную

2. **Подключение сервисов:**
   - PostgreSQL сервис должен быть запущен
   - Redis сервис должен быть запущен
   - API сервис должен быть подключен к PostgreSQL и Redis

3. **Логи Railway:**
   - Откройте логи вашего API сервиса
   - Проверьте наличие ошибок при старте
   - Должны быть сообщения о переменных окружения
   - Должны быть сообщения о подключении к БД

### Типичные ошибки:

#### 1. "Database connection string is required"
**Причина:** DATABASE_URL не установлен или PostgreSQL не подключен
**Решение:** 
- Убедитесь, что PostgreSQL сервис создан
- Подключите PostgreSQL к API сервису (Settings → Connect Service)

#### 2. "JWT Key is not configured"
**Причина:** Jwt__Key не установлен
**Решение:** Добавьте переменную `Jwt__Key` в настройках API сервиса

#### 3. Приложение не отвечает на healthcheck
**Причина:** Приложение падает при старте или не слушает правильный порт
**Решение:**
- Проверьте логи на наличие исключений
- Убедитесь, что все обязательные переменные окружения установлены

### Проверка после деплоя:

1. **Проверьте логи:**
   ```
   Должны быть сообщения:
   - "Environment: Production"
   - "PORT: [номер порта]"
   - "DATABASE_URL: set"
   - "Application starting on port [порт]"
   ```

2. **Проверьте health endpoint:**
   ```
   curl https://your-app.up.railway.app/api/health
   Должен вернуть: {"status":"healthy","timestamp":"..."}
   ```

3. **Проверьте Swagger:**
   ```
   https://your-app.up.railway.app/swagger/index.html
   Должен открыться Swagger UI
   ```

### Если проблема сохраняется:

1. **Проверьте все переменные окружения** (см. RAILWAY_ENV_VARS.md)
2. **Проверьте логи Railway** на наличие ошибок
3. **Убедитесь, что PostgreSQL и Redis запущены**
4. **Попробуйте пересоздать сервисы** на Railway

### Полезные команды для отладки:

В логах Railway вы должны увидеть:
- Информацию о переменных окружения
- Сообщения о подключении к БД
- Ошибки, если они есть

Если видите ошибки - скопируйте их и проверьте, что не хватает.

